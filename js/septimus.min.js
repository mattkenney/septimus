(function(){var d,i,a={};$.get("/gtfa_public/google_rail/stops.txt",function(l){d=$.csv.toArrays(l);i=_.map(d,function(m){return m[1];});i.shift();i.sort();});if(window.localStorage&&window.JSON){a=JSON.parse(localStorage.getItem("recent")||"[]");}function e(){var m=$("#stopfrom input").val(),l=$("#stopto input").val();$.ajax("http://www3.septa.org/hackathon/NextToArrive/",{data:$.param({req1:m,req2:l}),dataType:"jsonp",success:j(m,l)});}function k(l){return function(){a=_.filter(a,function(m){return(m.label!==l.label);});if(window.localStorage&&window.JSON){localStorage.setItem("recent",JSON.stringify(a));}g();};}function h(l,m){return function(){$.ajax("http://www3.septa.org/hackathon/RRSchedules/",{data:$.param({req1:m}),dataType:"jsonp",success:f(l,m)});};}function c(l){return function(){$("#stopfrom input").val(l.from);$("#stopto input").val(l.to);e();};}function j(m,l){return function(s){var p=$("#routes-list");p.empty();if(s.length){$.mobile.changePage("#routes");}else{alert("No route found?!");return;}for(var q=0;q<s.length;q++){var n=$("<li></li>").jqmData("role","list-divider").jqmData("theme","c").text(s[q].orig_departure_time+" - "+(s[q].term_arrival_time||s[q].orig_arrival_time)).appendTo(p);var o=$("<li></li>").jqmData("theme","c").appendTo(p);$link=o;$("<div></div>").addClass("ui-li-desc").text(s[q].orig_line+" "+s[q].orig_train).appendTo($link);$("<div></div>").text("Depart "+s[q].orig_departure_time+" ("+s[q].orig_delay+")").appendTo($link);$("<div></div>").text("> "+m).appendTo($link);$("<div></div>").text("Arrive "+s[q].orig_arrival_time).appendTo($link);$("<div></div>").text("> "+(s[q].Connection||l)).appendTo($link);if(s[q].isdirect==="true"){continue;}$("<span></span>").text(" - 1 connection").appendTo(n);o=$("<li></li>").jqmData("theme","c").appendTo(p);$link=o;$("<div></div>").addClass("ui-li-desc").text(s[q].term_line+" "+s[q].term_train).appendTo($link);$("<div></div>").text("Depart "+s[q].term_depart_time+" ("+s[q].term_delay+")").appendTo($link);$("<div></div>").text("> "+s[q].Connection).appendTo($link);$("<div></div>").text("Arrive "+s[q].term_arrival_time).appendTo($link);$("<div></div>").text("> "+l).appendTo($link);}p.listview("refresh");p.trigger("updatelayout");var r={from:m,to:l,label:m+" - "+l};a=_.filter(a,function(t){return(t.label!==r.label);});a.push(r);while(a.length>10){a.shift();}if(window.localStorage&&window.JSON){localStorage.setItem("recent",JSON.stringify(a));}};}function f(l,m){return function(p){var n=$("#detail-list");n.empty();$.mobile.changePage("#detail");$("<li></li>").jqmData("role","list-divider").jqmData("theme","c").text(l+" "+m).appendTo(n);for(var o=0;o<p.length;o++){$("<li></li>").jqmData("theme","c").text(p[o].sched_tm+" "+p[o].station).appendTo(n);}n.listview("refresh");n.trigger("updatelayout");};}function b(n,l,m){return function(){n.val(m);l.empty();l.listview("refresh");l.trigger("updatelayout");};}function g(){var n=$("#recent ul"),p=_.sortBy(a,"label");n.empty();for(var o=0;o<p.length;o++){var m=$("<li></li>").appendTo(n);var l=$("<a></a>").attr("href","javascript:void(0)").text(p[o].label).appendTo(m).click(c(p[o]));l=$("<a></a>").attr("href","javascript:void(0)").jqmData("icon","delete").click(k(p[o])).appendTo(m);}n.listview("refresh");n.trigger("updatelayout");$("#recent").toggle(!!p.length);}$(document).on("pageinit","#search",function(){$("#stopfrom ul,#stopto ul").on("listviewbeforefilter",function(p,o){var r=$(o.input),q=$(o.input).val().toLowerCase(),l=$(this);l.empty();if(i&&q){var n=_.filter(i,function(s){return(q===s.substring(0,q.length).toLowerCase());});for(var m=0;m<n.length;m++){$("<li></li>").text(n[m]).appendTo(l).click(b(r,l,n[m]));}}l.listview("refresh");l.trigger("updatelayout");});$("#search").on("pagebeforeshow",g);$("#search form").on("submit",e);$("#find").click(e);});})();
